<!DOCTYPE html>
<html>

<head>
    <meta charset='utf-8'>
    <title>Sky Clock</title>
    <meta name="author" content="voltavidTony">
    <meta name="description" content="A clock that shows sun's and moon's orbits">
    <meta name="keywords" content="JS, clock, sky, sun, moon">
    <meta name='viewport' content='width=device-width, initial-scale=1'>
    <style>
        body {
            background-color: black;
            color: white;
        }

        circle {
            fill: transparent;
            stroke-linecap: butt;
            stroke-width: 0.625em;
        }

        .orbitSVG {
            display: none;
            height: 20em;
            position: absolute;
            transform: translate(-50%, -50%);
            width: 20em;
        }

        #clockFace {
            font-family: Impact;
            font-size: 4em;
            position: absolute;
            text-align: center;
            transform: translate(-50%, -50%);
        }

        #container {
            left: 50%;
            position: absolute;
            top: 50%;
            transform: translate(-50%, -50%);
            width: fit-content;
        }

        #location {
            display: table;
            width: fit-content;
        }

        #location:hover #locationTooltip {
            display: table-cell;
        }

        #locationInner {
            background-color: black;
            border-radius: 50%;
            height: 1em;
            margin: 0.5em;
            width: 1em;
        }

        #locationOuter {
            background-color: currentColor;
            border-radius: 50% 50% 50% 0;
            display: inline-block;
            height: 2em;
            margin: 0.5em;
            transform: rotate(-45deg);
            width: 2em;
        }

        #locationTooltip {
            display: none;
            font-size: 1em;
            vertical-align: middle;
        }

        /* 
         * Moon Elements
         */

        #moon {
            fill: slategray;
            stroke: white;
            stroke-linecap: butt;
            stroke-width: 0.25em;
        }

        #moonBarDay {
            stroke: lightskyblue;
            stroke-width: 0.5em;
        }

        #moonBarNight {
            stroke: darkslategray;
            stroke-width: 0.5em;
        }

        #moonTickHour {
            stroke: white;
            stroke-dasharray: 0.0625em 1.574em;
            stroke-width: 1em;
        }

        /* 
         * Sun Elements
         */

        #sun {
            fill: gold;
            stroke: gold;
            stroke-dasharray: 0.0625em 0.265em;
            stroke-linecap: butt;
            stroke-width: 0.375em;
        }

        #sunBarDawn {
            stroke: darkorange;
        }

        #sunBarDay {
            stroke: lightskyblue;
        }

        #sunBarDusk {
            stroke: orangered;
        }

        #sunBarNight {
            stroke: midnightblue;
        }

        #sunTickRise {
            stroke: yellow;
            stroke-width: 0.875em;
        }

        #sunTickSet {
            stroke: yellow;
            stroke-width: 0.875em;
        }

        #sunTickHour {
            stroke: white;
            stroke-dasharray: 0.0625em 2.294em;
            stroke-width: 1.25em;
        }
    </style>
    <script src="suncalc.js"></script>
    <script>
        var geoloc = null;
        var moon = { noon: 0, rise: 0, set: 0, zero: 0 };
        var sun = { dawn: 0, dusk: 0, gol: 0, golEnd: 0, noon: 0, rise: 0, set: 0, zero: 0 };

        function $(id) { return document.getElementById(id); }

        function applyConfig(element, keys) {
            var params = new URLSearchParams(location.search);
            keys.forEach(key => {
                if (params.has(key))
                    element.style.setProperty(key, params.get(key));
            });
        }

        function dayFrac(date) {
            return (((
                date.getMilliseconds() / 1000
                + date.getSeconds()) / 60
                + date.getMinutes()) / 60
                + date.getHours()) / 24;
        }

        function getSkyData() {
            var xhr = new XMLHttpRequest();
            xhr.open("GET", "https://geolocation-db.com/json/", true);
            xhr.onload = function (e) {
                var loc = JSON.parse(xhr.responseText);
                geoloc = {
                    lat: loc.latitude,
                    long: loc.longitude
                };

                var date = new Date();

                var mTime = SunCalc.getMoonTimes(date, geoloc.lat, geoloc.long);
                moon.rise = dayFrac(mTime.rise);
                moon.set = dayFrac(mTime.set);
                moon.noon = (moon.rise + moon.set) / 2;
                moon.zero = moon.noon - 0.5;
                moon.rise -= moon.zero;
                moon.set -= moon.zero;

                var sunTimes = SunCalc.getTimes(date, geoloc.lat, geoloc.long);
                sun.noon = dayFrac(sunTimes.solarNoon);
                sun.zero = sun.noon - 0.5;
                sun.dawn = dayFrac(sunTimes.dawn) - sun.zero;
                sun.dusk = dayFrac(sunTimes.dusk) - sun.zero;
                sun.gol = dayFrac(sunTimes.goldenHour) - sun.zero;
                sun.golEnd = dayFrac(sunTimes.goldenHourEnd) - sun.zero;
                sun.rise = dayFrac(sunTimes.sunrise) - sun.zero;
                sun.set = dayFrac(sunTimes.sunsetStart) - sun.zero;

                setLightRing($("sunBarDawn"), sun.dawn, sun.golEnd, 9);
                setLightRing($("sunBarDay"), sun.golEnd, sun.gol, 9);
                setLightRing($("sunBarDusk"), sun.gol, sun.dusk, 9);
                setLightRing($("sunBarNight"), sun.dusk, sun.dawn, 9);
                setLightRing($("sunTickRise"), sun.rise, sun.rise + 0.00227, 9);
                setLightRing($("sunTickSet"), sun.set, sun.set + 0.00227, 9);
                $("sunRing").style.display = "block";

                setLightRing($("moonBarNight"), moon.set, moon.rise, 6);
                setLightRing($("moonBarDay"), moon.rise, moon.set, 6);
                $("moonRing").style.display = "block";

                placeBodies(date);
            };
            xhr.onerror = function () {
                console.error("Error getting location from https://geolocation-db.com/json/");
            };
            xhr.send(null);
        }

        function placeBodies(date) {
            var mrad = (dayFrac(date) - moon.zero) * Math.PI * 2;
            $("moon").style.transform = "translate(" + -Math.sin(mrad) * 6 + "em, " + Math.cos(mrad) * 6 + "em)";

            var srad = (dayFrac(date) - sun.zero) * Math.PI * 2;
            $("sun").style.transform = "translate(" + -Math.sin(srad) * 9 + "em, " + Math.cos(srad) * 9 + "em)";
        }

        function setLightRing(element, start, end, radius) {
            start = (start + 0.25) % 1;
            end = (end + 0.25) % 1;
            radius *= Math.PI * 2;

            if (end < start) {
                var a = end * radius - 0.03125;
                var b = (start - end) * radius + 0.0625;
                var c = (1 - start) * radius;
                element.style.strokeDasharray = a + "em " + b + "em " + c + "em";
            } else {
                var a = start * radius + 0.03125;
                var b = (end - start) * radius - 0.0625;
                var c = (1 - end) * radius;
                element.style.strokeDasharray = "0 " + a + "em " + b + "em " + c + "em";
            }
        }

        function setTime() {
            var date = new Date();

            var hh = date.getHours().toString().padStart(2, "0");
            var mm = date.getMinutes().toString().padStart(2, "0");
            $("clockFace").innerHTML = hh + "<br>" + mm;

            if (mm == 0) getSkyData();
            else placeBodies(date);
        }

        function setupClock() {
            applyConfig($("container"), ["font-size"]);
            setTimeout(() => {
                setInterval(setTime, 60000);
                setTime();
            }, (60 - (new Date()).getSeconds()) * 1000);
            getSkyData();
            setTime();
        }
    </script>
</head>

<body onload="setupClock();">
    <div id="location">
        <div id="locationOuter">
            <div id="locationInner"></div>
        </div>
        <span id="locationTooltip">This clock uses location services.<br>
            No information is saved or forwarded to third parties.</span>
    </div>
    <div id="container">
        <svg id="sunRing" class="orbitSVG" version="1.1" xmlns="http://www.w3.org/2000/svg">
            <circle id="sunTickHour" cx="10em" cy="10em" r="9em"></circle>
            <circle id="sunBarDawn" cx="10em" cy="10em" r="9em"></circle>
            <circle id="sunBarDay" cx="10em" cy="10em" r="9em"></circle>
            <circle id="sunBarDusk" cx="10em" cy="10em" r="9em"></circle>
            <circle id="sunBarNight" cx="10em" cy="10em" r="9em"></circle>
            <circle id="sunTickSet" cx="10em" cy="10em" r="9em"></circle>
            <circle id="sunTickRise" cx="10em" cy="10em" r="9em"></circle>
            <circle id="sun" cx="10em" cy="10em" r="0.625em"></circle>
        </svg>
        <svg id="moonRing" class="orbitSVG" version="1.1" xmlns="http://www.w3.org/2000/svg">
            <circle id="moonTickHour" cx="10em" cy="10em" r="6em"></circle>
            <circle id="moonBarNight" cx="10em" cy="10em" r="6em"></circle>
            <circle id="moonBarDay" cx="10em" cy="10em" r="6em"></circle>
            <circle id="moon" cx="10em" cy="10em" r="0.375em"></circle>
        </svg>
        <div id="clockFace">Please enable JavaScript</div>
    </div>
</body>

</html>